stages:
  - deploy-backend
  - build-frontend
  - deploy-frontend

variables:
  AWS_REGION: "ap-southeast-5"
  AWS_DEFAULT_REGION: "ap-southeast-5"
  LAMBDA_FUNCTION_NAME: "studywat-backend"
  S3_BUCKET_NAME: "studywat-frontend-my"

deploy_backend:
  stage: deploy-backend
  image: python:3.12
  only:
    changes:
      - backend/**/*
      - .gitlab-ci.yml
  before_script:  
    - pip install --upgrade pip
    - pip install awscli
  script:
    - cd backend
    - mkdir -p lambda_build/src
    - "pip install --platform manylinux2014_x86_64 --target=lambda_build --implementation cp --python-version 3.12 --only-binary=:all: --upgrade -r requirements.txt"
    - cp -r src/* lambda_build/src/
    - apt-get update && apt-get install -y zip
    - cd lambda_build && zip -r ../fastapi_lambda.zip . && cd ..
    - aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --zip-file fileb://fastapi_lambda.zip --region $AWS_REGION

build_frontend:
  stage: build-frontend
  image: node:20
  only:
    changes:
      - frontend/**/*
      - .gitlab-ci.yml
  script:
    - cd frontend
    - npm ci
    - echo "VITE_API_URL=$VITE_API_URL" > .env
    - npm run build
  artifacts:
    paths:
      - frontend/dist/

deploy_frontend:
  stage: deploy-frontend
  image: python:3.12
  dependencies:
    - build_frontend
  before_script:
    - pip install awscli
  script:
    - aws s3 sync frontend/dist/ s3://$S3_BUCKET_NAME/ --delete
    - aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_DISTRIBUTION_ID --paths '/*'