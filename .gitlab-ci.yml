stages:
  - deploy

variables:
  AWS_REGION: "ap-southeast-5"
  LAMBDA_FUNCTION_NAME: "studywat-backend"
  S3_BUCKET_NAME: "studywat-frontend-my"

deploy_backend:
  stage: deploy
  only:
    changes:
      - backend/**/*
  image: python:3.12
  before_script:  
    - pip install --upgrade pip
    - pip install awscli
  script:
    - cd backend
    - mkdir -p lambda_build/src
    - "pip install --platform manylinux2014_x86_64 --target=lambda_build --implementation cp --python-version 3.12 --only-binary=:all: --upgrade -r requirements.txt"
    - cp -r src/* lambda_build/src/
    - apt-get update && apt-get install -y zip
    - zip -r fastapi_lambda.zip lambda_build
    - aws lambda update-function-code --function-name $LAMBDA_FUNCTION_NAME --zip-file fileb://fastapi_lambda.zip --region $AWS_REGION

deploy_frontend:
  stage: deploy
  only:
    changes:
      - frontend/**/*
  image: node:20
  before_script:
    - npm install -g vite
    - npm install -g aws-cli
  script:
    - cd frontend
    - npm ci
    - npm run build
    - aws s3 sync dist/ s3://$S3_BUCKET_NAME/ --delete